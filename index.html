<!-- cd "C:\Users\ASUS\Desktop\NARUTO FINALPROJECT" ; node server.js -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Naruto API Encyclopedia</title>
<style>
  body { font-family: Arial; background: #ceedff; margin:0; padding:20px; }
  h1 { text-align: center; color: #d35400; }
  h3 { text-align: center; color: #d35400; }
  .controls { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
  select, input[type="text"], button { padding:10px; border-radius:6px; border:1px solid #ccc; }
  button { background:#2980b9; color:white; border:none; cursor:pointer; }
  button:hover { background:#1f5f88; }
  #results { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:15px; }
  .card { background:white; border-radius:10px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
  .card:hover { transform:translateY(-5px); }
  .card img { width:100%; height:180px; object-fit:cover; background:#ddd; }
  .card-content { padding:10px 12px; }
  .card-content h3 { margin:0 0 6px 0; font-size:16px; color:#d35400; }
  .card-content p { margin:2px 0; font-size:13px; color:#333; white-space:pre-line; }
</style>
</head>
<body>

<h1>Naruto API Encyclopedia</h1>
<h3>by: Ronnet</h3>

<div class="controls">
  <select id="collection">
    <option value="characters">Characters</option>
    <option value="tailed-beasts">Tailed Beasts</option>
  </select>
  <input type="text" id="searchInput" placeholder="Search by name...">
  <button onclick="searchAPI()">Search</button>
</div>

<div id="results"></div>

<script>
const API_CANDIDATES = [
    'http://localhost:3000/api',
    'https://dattebayo-api.onrender.com',
    'https://api-dattebayo.vercel.app'
];

function extractArrayFromJson(obj, depth = 0) {
    if (!obj || depth > 6) return null;
    if (Array.isArray(obj) && obj.length > 0 && typeof obj[0] === 'object') return obj;
    if (typeof obj === 'object') {
        for (const k of Object.keys(obj)) {
            try {
                const res = extractArrayFromJson(obj[k], depth + 1);
                if (res) return res;
            } catch (e) { /* ignore */ }
        }
    }
    return null;
}

async function searchAPI() {
    const collection = document.getElementById("collection").value;
    const query = document.getElementById("searchInput").value.trim().toLowerCase();
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "Loading...";

    // Only allow 'characters' or 'tailed-beasts'
    if (!['characters', 'tailed-beasts'].includes(collection)) {
        resultsDiv.innerHTML = 'Please select either Characters or Tailed Beasts.';
        return;
    }

    let items = [];
    let lastError = null;

    for (const base of API_CANDIDATES) {
        try {
            const url = `${base}/${collection}?page=1&limit=50`;
            console.debug('Trying API:', url);
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status} from ${base}`);
            const json = await response.json();
            const arr = extractArrayFromJson(json);
            if (arr) items = arr;
            else items = [];
            // successful fetch, stop trying other bases
            break;
        } catch (err) {
            console.warn('Fetch failed for', base, err);
            lastError = err;
        }
    }

    try {
        const filtered = query
            ? items.filter(item => ((item.name || item.title || '') + '').toLowerCase().includes(query))
            : items;

        resultsDiv.innerHTML = '';

        if (!filtered || filtered.length === 0) {
            let message = 'No results found.';
            if (lastError) message = `Error fetching data: ${lastError.message}`;
            resultsDiv.innerText = message;
            return;
        }

        filtered.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';

            let imageUrl = '';
            if (Array.isArray(item.images) && item.images.length > 0) imageUrl = item.images[0];
            if (imageUrl.startsWith('//')) imageUrl = 'https:' + imageUrl;

            const desc = item.description || item.about || item.bio || '';
            const meta = item.village || item.clan || item.affiliation || '';

            card.innerHTML = `
                <img src="${imageUrl || 'https://via.placeholder.com/420x180?text=No+Image'}"
                     alt="${item.name || ''}">
                <div class="card-content">
                    <h3>${item.name || 'No name'}</h3>
                    ${meta ? `<p><strong>Meta:</strong> ${meta}</p>` : ''}
                    ${desc ? `<p>${desc}</p>` : ''}
                </div>
            `;
            resultsDiv.appendChild(card);
        });

    } catch (err) {
        console.error(err);
        resultsDiv.innerText = 'Unexpected error rendering results.';
    }
}



document.getElementById('searchInput').addEventListener('keydown', function(e){
    if (e.key === 'Enter') searchAPI();
});

</script>

</body>
</html>
